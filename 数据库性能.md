## 数据库性能

### 数据库的性能测试目的和范围

目的：发现数据库相关的所有性能瓶颈

测试范围：

1、sql语句--慢查询等：select相关查询、索引、insert

2、资源使用率

3、数据库架构合理性

4、数据库的性能指标



### 数据库的常用架构

1、一主多从：读写分离，master负责写，slave负责读，会存在读写延时的情况

2、双机热备：读写在master上，slave复制master上的数据，不会有读写延迟现象，主机器会向slave写入所有数据

### 数据库主从同步的工作原理

主从同步原理：

1、master将改变记录到二进制日志（binary log）中

2、salve将master的binary log events拷贝到它的中继日志relay log

3、slave重做中继日志中的事件，将改变反映它自己的数据

###  数据库分库分表的设计方法

拆分的原因：

1、单表或库数据量太大

2、硬件不能升级

分库分表方案：

1、业务拆分：如用户、订单、商品等

2、垂直拆分：如商品拆分床上用品、其他用品

3、水平拆分（一致性哈西算法）



### Mysql数据库重点监控指标

1、QPS:queries per seconds :queries per seconds 每秒钟查询数量

show global status like 'Question%';

queries / seconds

2、TPS:tranaction per seconds 每秒钟事务数

TPS = （Com_commit+ Com_rollback）/ seconds

show global status like 'Com_commit';

show global status like 'Com_rollback';

3、线程连接数

show global status like 'Max_used_connections';

show global status like 'Threads%';

4、最大连接数

show variables like 'max_connections';

5、query cache

* 查询缓存用于缓存select查询结果

* 当下次接收到相同查询请求时，不再执行实际查询处理而直接返回结果

* 适用于大量查询、很少改变表中数据

* 开启query cache：

  *  修改my.cnf

  * 将query_cache_size设置为具体的大小，具体大小取决于查询的实际情况，最好设置为1024的倍数，参考值32M

  * 增加一行：query_cache_type = 0/1/2

    如果设置为1，将会幻想所有的结果，除非select语句使用SQL_NO_CACHE禁用了查询缓存

    如果设置为2，则只会缓存在select语句中通过SQL_CACHE指定需要缓存的查询

    query cached 命中率：

    show status like 'Qcahce%';

    query_cache_hits = (Qcache_hits / (Qcache_hits + Qcache_inserts)) * 100%;

  6、锁定状态：

  * show global status like '%lock%';

    Table_locks_waited / Table_locks_immediate 值越大代表表锁造成的阻塞约严重

  * Innodb_row_lock_waits innodb 行锁，太大可能时间隙锁造成

  7、主从延时

  * 查询主从延时时间：show salve status

  

  ### Mysql 慢查询

  定义：执行速度超过定义的时间的查询

  ​           不同的系统定义不同的慢查询指标

  慢查询开启：编辑/etc/my.cnf 在[mysqld]域中添加slow_query_log=1

  ​                       慢查询日志log：slow_query_log_file= /data/mysql/slow.log

  ​                       慢查询时长：long_query_time = 1

  ​         未使用索引的查询也被记录到慢查询日志中：log_queries_not_using_indexes=1

  慢查询日志分析：mysqldumpslow

  ​						参数：-s 是表示按照何种方式排序

  ​                                          c:访问计数

  ​						                   l: 锁定时间

  ​                                           r:返回记录  

  ​                                           t:查询时间

  ​                                           al:平均锁定时间

  ​                                           ar:平均返回记录数

  ​                                          at:平均查询时间                                   

  ​                                   -t 是top n的意思

  ​                                   -g 后边可以写一个正则匹配



### mysql select语句性能分析

* explain执行计划

  explain select语句

  ![explain](\images\explain.png)

id：select识别符，代表语句的执行顺序，一般在select嵌套查询时不同

​       id列数字越大越先执行，如果一致 说明顺序执行

select_type:

*  simple：表示不要union操作或者不包含子查询的简单select查询。有连接查询时，外层的查询为simple，且只有一个
* primary：表示需要union操作或者包含子查询的简单select查询。位于外层的查询为primary，且只有一个
* union：union连接的两个select查询，第一个查询是dervied派生表，除了第一个表外，第二个以后的表select_type都是union
* dependent union：与union一样，出现在union或union all语句中，但是这个查询要受到外部查询的影响
* union result：包含union的结果集，在union和union all语句中，因为它不需要参与查询，所有字段为null
* subquery：除了from字句中包含的子查询外，其他地方出现的子查询都可能是subquery
* dependent subquery：与dependent union 类似，表示这个subquery的查询要受到外部表查询的影响
* derived：from字句中出现的子查询，也叫做派生表，其他数据库中可能叫做内联视图或嵌套select

table：

* 显示的查询表名
* 如果有别名显示的是别名
* 如果不涉及对数据表的操作，显示为null
* 如果显示为尖括号括起来的<derived N>表示这是个临时表

type：

* 依次从好到差：

  system：表中只有一行数据或是空表，且只能用于myisam和memory表。如果是Innodb引擎表，type列在这个情况通常都是all或index

  const：使用唯一索引或主键，返回记录一定是1行记录的等值，where条件时，通常type是const，其他数据库也叫做唯一索引扫描

  eq_ref：

  ref、fulltext、ref_or_null、unique_subquery、index_subquery、range、index_merge、index、ALL

* 除了all之外，其他type都可以使用到索引，除了index_merge之外，其他的type只可以用到一个索引

  